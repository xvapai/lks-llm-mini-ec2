<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Low-Resource AI Chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #1e293b;
            padding: 1rem;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .header .status {
            font-size: 0.8rem;
            color: #94a3b8;
        }
        .header .status.connected { color: #10b981; }
        .header .status.error { color: #ef4444; }
        .controls {
            display: flex;
            gap: 0.5rem;
        }
        .btn {
            background: #334155;
            border: none;
            color: #e2e8f0;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }
        .btn:hover { background: #475569; }
        .btn:active { background: #1e293b; }
        .btn.danger { background: #991b1b; }
        .btn.danger:hover { background: #b91c1c; }
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            line-height: 1.5;
        }
        .message.user {
            background: #3b82f6;
            align-self: flex-end;
            margin-left: auto;
        }
        .message.assistant {
            background: #1e293b;
            align-self: flex-start;
            border: 1px solid #334155;
        }
        .message.system {
            background: #064e3b;
            align-self: center;
            font-size: 0.875rem;
            color: #6ee7b7;
        }
        .message.error {
            background: #450a0a;
            border: 1px solid #991b1b;
            align-self: stretch;
            max-width: 100%;
            color: #fca5a5;
        }
        .message.error .error-title {
            font-weight: 600;
            color: #ef4444;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        .message.error .error-detail {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            background: #1c0a0a;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
            white-space: pre-wrap;
            word-break: break-word;
            color: #fecaca;
        }
        .message.error .error-suggestions {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #991b1b;
        }
        .message.error .error-suggestions li {
            margin-left: 1.5rem;
            margin-top: 0.25rem;
            color: #fbbf24;
        }
        .input-area {
            background: #1e293b;
            border-top: 1px solid #334155;
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        .input-area input {
            flex: 1;
            background: #0f172a;
            border: 1px solid #334155;
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.375rem;
            font-size: 1rem;
        }
        .input-area input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .input-area button {
            background: #3b82f6;
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
        }
        .input-area button:hover { background: #2563eb; }
        .input-area button:disabled {
            background: #334155;
            cursor: not-allowed;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 0.5rem;
            color: #94a3b8;
            font-size: 0.875rem;
        }
        .loading.active { display: block; }
        .debug-panel {
            background: #1e293b;
            border-top: 1px solid #334155;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            color: #94a3b8;
            max-height: 150px;
            overflow-y: auto;
        }
        .debug-panel .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid #334155;
        }
        .debug-panel .log-entry.error { color: #ef4444; }
        .debug-panel .log-entry.success { color: #10b981; }
        .debug-panel .log-entry.info { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>ü§ñ AI Chat (Low-Resource)</h1>
            <div class="status" id="status">Checking connection...</div>
        </div>
        <div class="controls">
            <button class="btn" onclick="testBackend()">Test Backend</button>
            <button class="btn" onclick="clearChat()">Clear Chat</button>
            <button class="btn danger" onclick="toggleDebug()">Toggle Debug</button>
        </div>
    </div>

    <div class="chat-container" id="chat"></div>

    <div class="loading" id="loading">AI is thinking...</div>

    <div class="debug-panel" id="debugPanel" style="display: none;"></div>

    <div class="input-area">
        <input
            type="text"
            id="input"
            placeholder="Type your message..."
            onkeypress="if(event.key==='Enter') sendMessage()"
        />
        <button onclick="sendMessage()" id="sendBtn">Send</button>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const chat = document.getElementById('chat');
        const input = document.getElementById('input');
        const sendBtn = document.getElementById('sendBtn');
        const loading = document.getElementById('loading');
        const status = document.getElementById('status');
        const debugPanel = document.getElementById('debugPanel');

        // Debug logging
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            debugPanel.appendChild(entry);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function toggleDebug() {
            debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
        }

        // Check health on load
        async function checkHealth() {
            log('Checking backend health...', 'info');
            try {
                const res = await fetch(`${API_BASE}/health`);
                const data = await res.json();

                log(`Health check response: ${JSON.stringify(data)}`, 'success');

                let statusText = `Connected | Model: ${data.model} | DB: ${data.database}`;

                if (data.ollama === 'not running') {
                    statusText += ' | ‚ö†Ô∏è Ollama NOT RUNNING';
                    status.classList.add('error');
                    status.classList.remove('connected');
                    addErrorMessage(
                        'Ollama Not Running',
                        'Ollama service is not running. The chat will not work.',
                        [
                            'SSH into your server',
                            'Run: sudo systemctl start ollama',
                            'Run: ollama pull phi',
                            'Refresh this page'
                        ]
                    );
                } else if (data.model_available === false) {
                    statusText += ' | ‚ö†Ô∏è Model not downloaded';
                    status.classList.add('error');
                    status.classList.remove('connected');
                    addErrorMessage(
                        'Model Not Found',
                        `Model "${data.model}" is not available.`,
                        [
                            'SSH into your server',
                            `Run: ollama pull ${data.model}`,
                            'Wait for download to complete',
                            'Refresh this page'
                        ]
                    );
                } else {
                    status.classList.add('connected');
                    status.classList.remove('error');
                }

                status.textContent = statusText;
            } catch (e) {
                log(`Health check failed: ${e.message}`, 'error');
                status.textContent = 'Backend unreachable';
                status.classList.remove('connected');
                status.classList.add('error');

                addErrorMessage(
                    'Backend Unreachable',
                    `Cannot connect to backend at ${API_BASE}`,
                    [
                        'Check if backend is running: sudo systemctl status chatapp',
                        'Check if port 8000 is accessible',
                        'Check security group allows port 8000',
                        'Try: sudo systemctl restart chatapp'
                    ]
                );
            }
        }

        // Add message to UI
        function addMessage(role, content) {
            const msg = document.createElement('div');
            msg.className = `message ${role}`;
            msg.textContent = content;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        // Add detailed error message
        function addErrorMessage(title, detail, suggestions = []) {
            const msg = document.createElement('div');
            msg.className = 'message error';

            let html = `<div class="error-title">‚ùå ${title}</div>`;
            html += `<div>${detail}</div>`;

            if (suggestions.length > 0) {
                html += '<div class="error-suggestions"><strong>How to fix:</strong><ul>';
                suggestions.forEach(s => {
                    html += `<li>${s}</li>`;
                });
                html += '</ul></div>';
            }

            msg.innerHTML = html;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        // Send message
        async function sendMessage() {
            const message = input.value.trim();
            if (!message) return;

            // Disable input
            input.disabled = true;
            sendBtn.disabled = true;
            loading.classList.add('active');

            // Show user message
            addMessage('user', message);
            input.value = '';

            log(`Sending message: "${message}"`, 'info');

            try {
                const res = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        use_history: true
                    })
                });

                log(`Response status: ${res.status}`, res.ok ? 'success' : 'error');

                if (!res.ok) {
                    const errorData = await res.json();
                    log(`Error response: ${JSON.stringify(errorData)}`, 'error');

                    let suggestions = [];

                    // Parse error and provide solutions
                    if (errorData.detail) {
                        const detail = errorData.detail.toLowerCase();

                        if (detail.includes('ollama') && detail.includes('not running')) {
                            suggestions = [
                                'Run: sudo systemctl start ollama',
                                'Run: sudo systemctl enable ollama',
                                'Verify with: sudo systemctl status ollama'
                            ];
                        } else if (detail.includes('model') && detail.includes('not found')) {
                            suggestions = [
                                'Run: ollama list (to see available models)',
                                'Run: ollama pull phi (to download the model)',
                                'Or change model in .env file'
                            ];
                        } else if (detail.includes('timeout')) {
                            suggestions = [
                                'The model is too slow for your message',
                                'Try a shorter message',
                                'Or use a smaller model (tinyllama)'
                            ];
                        } else if (detail.includes('connect')) {
                            suggestions = [
                                'Backend cannot reach Ollama',
                                'Check: curl http://localhost:11434/api/tags',
                                'Restart Ollama: sudo systemctl restart ollama'
                            ];
                        }
                    }

                    addErrorMessage(
                        `Error ${res.status}`,
                        errorData.detail || 'Unknown error occurred',
                        suggestions
                    );

                    throw new Error(errorData.detail || 'Request failed');
                }

                const data = await res.json();
                log(`Received response from ${data.model}`, 'success');
                addMessage('assistant', data.response);

            } catch (e) {
                log(`Exception: ${e.message}`, 'error');
                if (!e.message.includes('Error')) {
                    addErrorMessage(
                        'Network Error',
                        e.message,
                        [
                            'Check your internet connection',
                            'Verify backend is running',
                            'Check browser console (F12) for details'
                        ]
                    );
                }
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                loading.classList.remove('active');
                input.focus();
            }
        }

        // Test backend
        async function testBackend() {
            log('Running backend tests...', 'info');

            // Test 1: Health
            try {
                const health = await fetch(`${API_BASE}/health`);
                const healthData = await health.json();
                log(`‚úì Health check: ${JSON.stringify(healthData)}`, 'success');
            } catch (e) {
                log(`‚úó Health check failed: ${e.message}`, 'error');
            }

            // Test 2: History
            try {
                const history = await fetch(`${API_BASE}/history`);
                const historyData = await history.json();
                log(`‚úì History: ${historyData.history.length} messages`, 'success');
            } catch (e) {
                log(`‚úó History failed: ${e.message}`, 'error');
            }

            // Test 3: Simple chat
            try {
                log('Testing chat endpoint with simple message...', 'info');
                const chat = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'hi', use_history: false })
                });

                if (chat.ok) {
                    const chatData = await chat.json();
                    log(`‚úì Chat test successful: ${chatData.response.substring(0, 50)}...`, 'success');
                } else {
                    const errorData = await chat.json();
                    log(`‚úó Chat test failed: ${JSON.stringify(errorData)}`, 'error');
                }
            } catch (e) {
                log(`‚úó Chat test failed: ${e.message}`, 'error');
            }

            addMessage('system', 'Backend test complete. Check debug panel for results.');
            debugPanel.style.display = 'block';
        }

        // Clear chat
        async function clearChat() {
            if (!confirm('Clear all chat history?')) return;

            try {
                await fetch(`${API_BASE}/history`, { method: 'DELETE' });
                chat.innerHTML = '';
                addMessage('system', 'Chat history cleared');
                log('Chat history cleared', 'success');
            } catch (e) {
                log(`Clear failed: ${e.message}`, 'error');
                addMessage('system', `Error: ${e.message}`);
            }
        }

        // Initialize
        log('Frontend initialized', 'info');
        checkHealth();
        addMessage('system', 'Welcome! Type a message to start chatting. Click "Toggle Debug" to see logs.');
    </script>
</body>
</html>
